## Transactional Handling

> **Transaction** = A set of operations that must ALL succeed or ALL fail together

### Why Transactions?

**Example: Bank Transfer**

```
Account 1 (Balance: ₹500)  →  Debit ₹500  →  Balance: ₹0
Account 2 (Balance: ₹1000) →  Credit ₹500 →  Balance: ₹1500

Total: ₹1500 (should remain same before and after transfer)
```

**Problem without Transaction**:
- If Debit succeeds but Credit fails → Money disappears!
- Data becomes **inconsistent**

**Solution with Transaction**:
- If Credit fails → **Rollback** Debit operation
- Only if BOTH succeed → **Commit** the changes

---

### Key Concepts

| Concept | Meaning |
|---------|---------|
| **Data Consistency** | Data should remain valid before and after operations |
| **Atomicity** | "Sab kuch ho ya kuch bhi na ho" - All or Nothing |
| **Commit** | Permanently save all changes to database |
| **Rollback** | Undo all changes, restore previous state |
| **AutoCommit** | By default `true` - each query commits automatically |

---

### Transaction Methods

```java
connection.setAutoCommit(false);  // Disable auto-commit
connection.commit();              // Save all changes
connection.rollback();            // Undo all changes
```

---

### Complete Bank Transaction Example

#### Step 1: Create Database and Table

```sql
-- Create database
CREATE DATABASE IF NOT EXISTS lenden;
USE lenden;

-- Create accounts table
CREATE TABLE accounts(
    id INT AUTO_INCREMENT PRIMARY KEY,
    account_number INT NOT NULL,
    name VARCHAR(255) NOT NULL,
    balance DOUBLE DEFAULT 1000.0
);

-- Insert sample data
INSERT INTO accounts(account_number, name) VALUES(101, "Ankit");
INSERT INTO accounts(account_number, name) VALUES(102, "Rahul");
```

---

#### Step 2: Helper Method - Check Sufficient Balance

```java
static boolean isSufficient(Connection connection, int account_number, double amount) {
    try {
        String query = "SELECT balance FROM accounts WHERE account_number = ?";
        PreparedStatement preparedStatement = connection.prepareStatement(query);
        preparedStatement.setInt(1, account_number);
        ResultSet resultSet = preparedStatement.executeQuery();
        
        if(resultSet.next()) {
            double current_balance = resultSet.getDouble("balance");
            if(amount > current_balance) {
                return false;  // Insufficient balance
            } else {
                return true;   // Sufficient balance
            }
        }
    } catch (SQLException e) {
        System.out.println(e.getMessage());
    }
    return false;
}
```

---

#### Step 3: Complete Transaction Code

```java
import java.sql.*;
import java.util.Scanner;

public class BankTransaction {
    private static final String url = "jdbc:mysql://localhost:3306/lenden";
    private static final String username = "root";
    private static final String password = "12345";
    
    public static void main(String[] args) {
        try {
            Connection connection = DriverManager.getConnection(url, username, password);
            
            // IMPORTANT: Disable auto-commit for transaction
            connection.setAutoCommit(false);
            
            // Prepare debit and credit queries
            String debit_query = "UPDATE accounts SET balance = balance - ? WHERE account_number = ?";
            String credit_query = "UPDATE accounts SET balance = balance + ? WHERE account_number = ?";
            
            PreparedStatement debitPreparedStatement = connection.prepareStatement(debit_query);
            PreparedStatement creditPreparedStatement = connection.prepareStatement(credit_query);
            
            Scanner scanner = new Scanner(System.in);
            
            System.out.print("Enter Account Number: ");
            int account_number = scanner.nextInt();
            System.out.print("Enter Amount: ");
            double amount = scanner.nextDouble();
            
            // Set parameters for debit (from account 101)
            debitPreparedStatement.setDouble(1, amount);
            debitPreparedStatement.setInt(2, account_number);
            
            // Set parameters for credit (to account 102)
            creditPreparedStatement.setDouble(1, amount);
            creditPreparedStatement.setInt(2, 102);
            
            // Execute operations
            debitPreparedStatement.executeUpdate();
            creditPreparedStatement.executeUpdate();
            
            // Check if balance was sufficient
            if(isSufficient(connection, account_number, amount)) {
                connection.commit();  //  Save changes
                System.out.println("Transaction Successful!");
            } else {
                connection.rollback();  //  Undo changes
                System.out.println("Transaction Failed - Insufficient Balance!!");
            }
            
            // Close all resources
            debitPreparedStatement.close();
            creditPreparedStatement.close();
            scanner.close();
            connection.close();
            
        } catch (SQLException e) {
            System.out.println(e.getMessage());
        }
    }
    
    // Helper method (defined above)
    static boolean isSufficient(Connection connection, int account_number, double amount) {
        // ... (code from Step 2)
    }
}
```

---

### Transaction Flow Diagram

```
                    ┌─────────────────┐
                    │  Start Transfer │
                    └────────┬────────┘
                             │
                    ┌────────▼────────┐
                    │ setAutoCommit   │
                    │    (false)      │
                    └────────┬────────┘
                             │
              ┌──────────────▼──────────────┐
              │   Debit from Account 1      │
              │   Credit to Account 2       │
              └──────────────┬──────────────┘
                             │
                    ┌────────▼────────┐
                    │ Check Balance   │
                    │  Sufficient?    │
                    └────────┬────────┘
                             │
              ┌──────────────┴──────────────┐
              │                             │
       ┌──────▼──────┐               ┌──────▼──────┐
       │    YES      │               │    NO       │
       │  commit()   │               │ rollback()  │
       │  Success!   │               │  Failed!    │
       └─────────────┘               └─────────────┘
```

---

## Mini Project: Bus Travelling Agency

### Database Schema

#### Table 1: Bus

| Column | Data Type | Description |
|--------|-----------|-------------|
| bus_no | INT (PK) | Unique bus number |
| date_booked | DATE | Booking date |
| capacity | INT | Total seats |
| is_available | BOOLEAN | Availability status |
| starting_point | VARCHAR | Departure location |
| ending_point | VARCHAR | Destination location |

#### Table 2: Customer/Passenger

| Column | Data Type | Description |
|--------|-----------|-------------|
| pass_id | INT (PK) | Unique passenger ID |
| name | VARCHAR | Passenger name |
| age | INT | Passenger age |
| date_booked | DATE | Ticket booking date |
| amount | DOUBLE | Ticket price paid |
| bus_id | INT (FK) | Reference to Bus table |
| starting_point | VARCHAR | Boarding point |
| destination | VARCHAR | Drop-off point |

### SQL Setup

```sql
-- Create database
CREATE DATABASE IF NOT EXISTS bus_agency;
USE bus_agency;

-- Create Bus table
CREATE TABLE bus(
    bus_no INT PRIMARY KEY,
    date_booked DATE,
    capacity INT DEFAULT 40,
    is_available BOOLEAN DEFAULT TRUE,
    starting_point VARCHAR(100),
    ending_point VARCHAR(100)
);

-- Create Passenger table
CREATE TABLE passenger(
    pass_id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    age INT,
    date_booked DATE,
    amount DOUBLE,
    bus_id INT,
    starting_point VARCHAR(100),
    destination VARCHAR(100),
    FOREIGN KEY (bus_id) REFERENCES bus(bus_no)
);
```

---

## Quick Reference Card

### Batch Processing

```java
// With Statement
statement.addBatch(query);
int[] result = statement.executeBatch();

// With PreparedStatement
preparedStatement.setXxx(index, value);
preparedStatement.addBatch();
int[] result = preparedStatement.executeBatch();
```

### Transactional Handling

```java
connection.setAutoCommit(false);  // Start transaction

// Execute operations...

if(success) {
    connection.commit();    // Save changes
} else {
    connection.rollback();  // Undo changes
}
```

### Resource Cleanup

```java
preparedStatement.close();
resultSet.close();
scanner.close();
connection.close();
```

---

