# Session Management

---

## What is a Session?

A **session** is a way to **identify a user across multiple requests**.

### Why is Session Management Needed?

HTTP is a **stateless protocol** - each request is independent. The server doesn't remember previous requests from the same user.

```
┌─────────────────────────────────────────────────────────────┐
│                    THE PROBLEM                              │
└─────────────────────────────────────────────────────────────┘

Request 1: User logs in
    Server: "Welcome, Rahul!"

Request 2: User adds item to cart
    Server: "Who are you?" ← Server doesn't remember!

Request 3: User wants to checkout
    Server: "Who are you?" ← Server still doesn't remember!
```

### Solution: Session Management Techniques

| Technique | Data Stored At | Best For |
|-----------|----------------|----------|
| Cookies | Client (Browser) | Small data, preferences |
| HttpSession | Server | Secure data, shopping carts |
| URL Rewriting | URL | When cookies disabled |

---

# 1. Cookies

---

## What is a Cookie?

A **cookie** is a small piece of data (text file) stored on the **client's browser** by the server.

### Cookie Characteristics:

- Stored on **client side** (browser)
- **Maximum size**: 4KB per cookie
- Can be **persistent** (saved to disk) or **session** (deleted when browser closes)
- Sent with **every request** to the same domain

---

## Cookie Flow Diagram

```
┌─────────────────────────────────────────────────────────────┐
│                    COOKIE FLOW                               │
└─────────────────────────────────────────────────────────────┘

    ┌──────────┐                              ┌──────────┐
    │  Client  │                              │  Server  │
    │ (Browser)│                              │          │
    └──────────┘                              └──────────┘
         │                                         │
         │  1. First Request (Login)               │
         │ ────────────────────────────────────>   │
         │                                         │
         │  2. Response + Set-Cookie: user=Rahul   │
         │ <────────────────────────────────────   │
         │                                         │
    [Browser stores cookie]                        │
         │                                         │
         │  3. Next Request + Cookie: user=Rahul   │
         │ ────────────────────────────────────>   │
         │                                         │
         │  4. Server reads cookie, knows user     │
         │ <────────────────────────────────────   │
         │                                         │
```

---

## Cookie Class - Important Methods

| Method | Description |
|--------|-------------|
| `new Cookie(name, value)` | Create a new cookie |
| `setMaxAge(seconds)` | Set expiry time (-1 = session cookie, 0 = delete) |
| `getValue()` | Get cookie value |
| `getName()` | Get cookie name |
| `setPath(path)` | Set URL path where cookie is valid |
| `setSecure(true)` | Cookie sent only over HTTPS |

---

## Complete Cookie Example

### SetCookieServlet.java (Creating Cookie)

```java
package com.example;

import javax.servlet.*;
import javax.servlet.http.*;
import java.io.*;

public class SetCookieServlet extends HttpServlet {
    
    @Override
    public void doPost(HttpServletRequest request, HttpServletResponse response) 
            throws ServletException, IOException {
        
        // Get username from form
        String username = request.getParameter("username");
        
        // ═══════════════════════════════════════
        //          CREATING COOKIE
        // ═══════════════════════════════════════
        
        // Step 1: Create cookie object
        Cookie userCookie = new Cookie("username", username);
        
        // Step 2: Set cookie properties
        userCookie.setMaxAge(60 * 60 * 24);  // 1 day (in seconds)
        // -1 = session cookie (deleted when browser closes)
        //  0 = delete cookie immediately
        
        // Step 3: Add cookie to response
        response.addCookie(userCookie);
        
        // Also create a preference cookie
        Cookie themeCookie = new Cookie("theme", "dark");
        themeCookie.setMaxAge(60 * 60 * 24 * 30);  // 30 days
        response.addCookie(themeCookie);
        
        // Send response
        response.setContentType("text/html");
        PrintWriter out = response.getWriter();
        out.println("<h2>Cookies Set Successfully!</h2>");
        out.println("<p>Username: " + username + "</p>");
        out.println("<a href='getCookie'>View Cookies</a>");
    }
}
```

### GetCookieServlet.java (Reading Cookie)

```java
package com.example;

import javax.servlet.*;
import javax.servlet.http.*;
import java.io.*;

public class GetCookieServlet extends HttpServlet {
    
    @Override
    public void doGet(HttpServletRequest request, HttpServletResponse response) 
            throws ServletException, IOException {
        
        response.setContentType("text/html");
        PrintWriter out = response.getWriter();
        
        // ═══════════════════════════════════════
        //          READING COOKIES
        // ═══════════════════════════════════════
        
        // Step 1: Get all cookies from request
        Cookie[] cookies = request.getCookies();
        
        out.println("<h2>All Cookies:</h2>");
        
        // Step 2: Check if cookies exist
        if (cookies != null) {
            // Step 3: Loop through all cookies
            for (Cookie cookie : cookies) {
                out.println("<p>");
                out.println("<b>Name:</b> " + cookie.getName());
                out.println(" | <b>Value:</b> " + cookie.getValue());
                out.println("</p>");
                
                // Find specific cookie
                if (cookie.getName().equals("username")) {
                    out.println("<h3>Welcome back, " + cookie.getValue() + "!</h3>");
                }
            }
        } else {
            out.println("<p>No cookies found!</p>");
        }
    }
}
```

### DeleteCookieServlet.java (Deleting Cookie)

```java
package com.example;

import javax.servlet.*;
import javax.servlet.http.*;
import java.io.*;

public class DeleteCookieServlet extends HttpServlet {
    
    @Override
    public void doGet(HttpServletRequest request, HttpServletResponse response) 
            throws ServletException, IOException {
        
        // ═══════════════════════════════════════
        //          DELETING COOKIE
        // ═══════════════════════════════════════
        
        // Step 1: Create cookie with same name
        Cookie deleteCookie = new Cookie("username", "");
        
        // Step 2: Set maxAge to 0 (delete immediately)
        deleteCookie.setMaxAge(0);
        
        // Step 3: Add to response
        response.addCookie(deleteCookie);
        
        response.setContentType("text/html");
        PrintWriter out = response.getWriter();
        out.println("<h2>Cookie Deleted!</h2>");
        out.println("<a href='getCookie'>Check Cookies</a>");
    }
}
```

---

## Cookie Advantages & Disadvantages

| Advantages | Disadvantages |
|------------|---------------|
| Simple to implement | Limited size (4KB) |
| Reduces server load | Can be disabled by user |
| Persistent across sessions | Not secure (visible in browser) |
| Works without server memory | Sent with every request (bandwidth) |

---

# 2. HttpSession

---

## What is HttpSession?

**HttpSession** is a server-side session management technique where session data is stored on the **server**.

### HttpSession Characteristics:

- Data stored on **server side**
- Client only stores **session ID** (usually in cookie)
- **More secure** than cookies
- **No size limit** (limited by server memory)
- Can store **any Java object**

---

## HttpSession Flow Diagram

```
┌─────────────────────────────────────────────────────────────┐
│                   HttpSession FLOW                           │
└─────────────────────────────────────────────────────────────┘

    ┌──────────┐                              ┌──────────┐
    │  Client  │                              │  Server  │
    │ (Browser)│                              │          │
    └──────────┘                              └──────────┘
         │                                         │
         │  1. First Request                       │
         │ ────────────────────────────────────>   │
         │                                         │
         │                              ┌────────────────────┐
         │                              │ Creates session    │
         │                              │ ID = ABC123        │
         │                              │ Stores: user=Rahul │
         │                              └────────────────────┘
         │                                         │
         │  2. Response + Session ID (ABC123)      │
         │ <────────────────────────────────────   │
         │                                         │
    [Browser stores session ID in cookie]          │
         │                                         │
         │  3. Next Request + Session ID (ABC123)  │
         │ ────────────────────────────────────>   │
         │                                         │
         │                        [Server finds session ABC123]
         │                        [Retrieves: user=Rahul]
         │                                         │
```

---

## HttpSession - Important Methods

| Method | Description |
|--------|-------------|
| `request.getSession()` | Get existing session or create new one |
| `request.getSession(false)` | Get existing session only (null if doesn't exist) |
| `session.setAttribute(name, value)` | Store data in session |
| `session.getAttribute(name)` | Retrieve data from session |
| `session.removeAttribute(name)` | Remove specific attribute |
| `session.invalidate()` | Destroy the session |
| `session.getId()` | Get session ID |
| `session.setMaxInactiveInterval(seconds)` | Set session timeout |
| `session.getCreationTime()` | Get session creation time |
| `session.getLastAccessedTime()` | Get last access time |
| `session.isNew()` | Check if session is newly created |

---

## Complete HttpSession Example

### LoginServlet.java (Creating Session)

```java
package com.example;

import javax.servlet.*;
import javax.servlet.http.*;
import java.io.*;

public class LoginServlet extends HttpServlet {
    
    @Override
    public void doPost(HttpServletRequest request, HttpServletResponse response) 
            throws ServletException, IOException {
        
        String username = request.getParameter("username");
        String password = request.getParameter("password");
        
        response.setContentType("text/html");
        PrintWriter out = response.getWriter();
        
        // Simple validation (in real app, check from database)
        if (username.equals("admin") && password.equals("admin123")) {
            
            // ═══════════════════════════════════════
            //         CREATING SESSION
            // ═══════════════════════════════════════
            
            // Step 1: Get/Create session
            HttpSession session = request.getSession();
            
            // Step 2: Store data in session
            session.setAttribute("user", username);
            session.setAttribute("role", "admin");
            session.setAttribute("loginTime", System.currentTimeMillis());
            
            // Step 3: Set session timeout (30 minutes)
            session.setMaxInactiveInterval(30 * 60);
            
            out.println("<h2>Login Successful!</h2>");
            out.println("<p>Session ID: " + session.getId() + "</p>");
            out.println("<a href='dashboard'>Go to Dashboard</a>");
            
        } else {
            out.println("<h2 style='color:red;'>Invalid Credentials!</h2>");
            out.println("<a href='login.html'>Try Again</a>");
        }
    }
}
```

### DashboardServlet.java (Reading Session)

```java
package com.example;

import javax.servlet.*;
import javax.servlet.http.*;
import java.io.*;

public class DashboardServlet extends HttpServlet {
    
    @Override
    public void doGet(HttpServletRequest request, HttpServletResponse response) 
            throws ServletException, IOException {
        
        response.setContentType("text/html");
        PrintWriter out = response.getWriter();
        
        // ═══════════════════════════════════════
        //         READING SESSION
        // ═══════════════════════════════════════
        
        // Get existing session (false = don't create new)
        HttpSession session = request.getSession(false);
        
        // Check if session exists and user is logged in
        if (session != null && session.getAttribute("user") != null) {
            
            // Retrieve data from session
            String user = (String) session.getAttribute("user");
            String role = (String) session.getAttribute("role");
            
            out.println("<h2>Welcome to Dashboard</h2>");
            out.println("<p><b>User:</b> " + user + "</p>");
            out.println("<p><b>Role:</b> " + role + "</p>");
            out.println("<p><b>Session ID:</b> " + session.getId() + "</p>");
            out.println("<a href='logout'>Logout</a>");
            
        } else {
            // No session or user not logged in
            out.println("<h2>Please Login First!</h2>");
            out.println("<a href='login.html'>Login</a>");
        }
    }
}
```

### LogoutServlet.java (Destroying Session)

```java
package com.example;

import javax.servlet.*;
import javax.servlet.http.*;
import java.io.*;

public class LogoutServlet extends HttpServlet {
    
    @Override
    public void doGet(HttpServletRequest request, HttpServletResponse response) 
            throws ServletException, IOException {
        
        // ═══════════════════════════════════════
        //         DESTROYING SESSION
        // ═══════════════════════════════════════
        
        HttpSession session = request.getSession(false);
        
        if (session != null) {
            // Remove specific attribute
            session.removeAttribute("user");
            
            // OR destroy entire session
            session.invalidate();
        }
        
        response.setContentType("text/html");
        PrintWriter out = response.getWriter();
        out.println("<h2>Logged Out Successfully!</h2>");
        out.println("<a href='login.html'>Login Again</a>");
    }
}
```

---

## HttpSession Advantages & Disadvantages

| Advantages | Disadvantages |
|------------|---------------|
| Can store any Java object | Uses server memory |
| More secure (data on server) | Session can be hijacked if ID stolen |
| No size limit | Requires session ID tracking |
| User cannot modify data | Not shared across multiple servers |

---

# 3. URL Rewriting

---

## What is URL Rewriting?

URL Rewriting is a technique where the **session ID is appended to every URL** instead of using cookies.

### When to Use?

- When user has **disabled cookies** in browser
- As a **fallback** mechanism when cookies don't work

---

## URL Rewriting Flow

```
Without URL Rewriting:
    http://localhost:8080/app/dashboard

With URL Rewriting:
    http://localhost:8080/app/dashboard;jsessionid=ABC123DEF456
                                        └────────────────────┘
                                            Session ID appended
```

---

## How to Implement URL Rewriting

### Using response.encodeURL()

```java
package com.example;

import javax.servlet.*;
import javax.servlet.http.*;
import java.io.*;

public class URLRewriteServlet extends HttpServlet {
    
    @Override
    public void doGet(HttpServletRequest request, HttpServletResponse response) 
            throws ServletException, IOException {
        
        response.setContentType("text/html");
        PrintWriter out = response.getWriter();
        
        // Create/Get session
        HttpSession session = request.getSession();
        session.setAttribute("user", "Rahul");
        
        // ═══════════════════════════════════════
        //         URL REWRITING
        // ═══════════════════════════════════════
        
        // Normal URL
        String normalURL = "dashboard";
        
        // Encoded URL (adds session ID if cookies disabled)
        String encodedURL = response.encodeURL("dashboard");
        
        out.println("<h2>URL Rewriting Example</h2>");
        
        // Normal link (won't work if cookies disabled)
        out.println("<p><a href='" + normalURL + "'>Normal Link</a></p>");
        
        // Rewritten link (works even if cookies disabled)
        out.println("<p><a href='" + encodedURL + "'>Encoded Link</a></p>");
        out.println("<p>Encoded URL: " + encodedURL + "</p>");
        
        // For redirects, use encodeRedirectURL
        // response.sendRedirect(response.encodeRedirectURL("dashboard"));
    }
}
```

### Important Methods:

| Method | Use For |
|--------|---------|
| `response.encodeURL(url)` | Encoding URLs in links |
| `response.encodeRedirectURL(url)` | Encoding URLs for redirects |

---

## URL Rewriting Advantages & Disadvantages

| Advantages | Disadvantages |
|------------|---------------|
| Works when cookies disabled | Session ID visible in URL |
| No client-side storage needed | URL looks ugly |
| Simple to implement | Security risk (ID in browser history) |
| | Every link must be encoded |
| | Bookmarking shares session |

---

## Session Management - Comparison Summary

| Feature | Cookies | HttpSession | URL Rewriting |
|---------|---------|-------------|---------------|
| **Data Stored At** | Client | Server | URL |
| **Security** | Low | High | Low |
| **Size Limit** | 4KB | No limit | URL length limit |
| **Works if cookies disabled** | No | No (needs cookie for ID) | Yes |
| **Visible to User** | Yes (in browser) | No | Yes (in URL) |
| **Best For** | Preferences, small data | Login, shopping cart | Fallback |

---
