# Filters

---

## What is a Filter?

A **Filter** is a Java component that can **intercept requests and responses** before they reach a servlet or after they leave.

### Common Uses of Filters:

- **Logging** - Log all requests
- **Authentication** - Check if user is logged in
- **Compression** - Compress response
- **Encryption** - Encrypt/decrypt data
- **Input validation** - Validate request parameters

---

## Filter Flow Diagram

```
┌─────────────────────────────────────────────────────────────┐
│                      FILTER FLOW                            │
└─────────────────────────────────────────────────────────────┘

    ┌──────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐
    │  Client  │ ──> │ Filter 1 │ ──> │ Filter 2 │ ──> │ Servlet  │
    │          │     │          │     │          │     │          │
    └──────────┘     └──────────┘     └──────────┘     └──────────┘
         ↑                │                │                │
         │                ↓                ↓                ↓
         │           Pre-process      Pre-process       Process
         │                │                │                │
         │                ↓                ↓                ↓
         └────────── Post-process ← Post-process ← Response ┘
         
    ════════════════════════════════════════════════════════════
                        FILTER CHAIN
    ════════════════════════════════════════════════════════════
```

---

## Filter Interface - Methods

The `javax.servlet.Filter` interface has 3 methods:

| Method | Called When | Purpose |
|--------|-------------|---------|
| `init(FilterConfig)` | Filter is loaded | Initialization |
| `doFilter(request, response, chain)` | Each request | Filter logic |
| `destroy()` | Filter is unloaded | Cleanup |

---

## Creating a Simple Logging Filter

### LoggingFilter.java

```java
package com.example;

import javax.servlet.*;
import javax.servlet.http.*;
import java.io.*;

public class LoggingFilter implements Filter {
    
    // ═══════════════════════════════════════
    //         1. INITIALIZATION
    // ═══════════════════════════════════════
    @Override
    public void init(FilterConfig filterConfig) throws ServletException {
        System.out.println("LoggingFilter initialized");
    }
    
    // ═══════════════════════════════════════
    //         2. FILTER LOGIC
    // ═══════════════════════════════════════
    @Override
    public void doFilter(ServletRequest request, 
                         ServletResponse response, 
                         FilterChain chain) 
            throws IOException, ServletException {
        
        HttpServletRequest req = (HttpServletRequest) request;
        
        // ─── PRE-PROCESSING (Before Servlet) ───
        long startTime = System.currentTimeMillis();
        System.out.println("═══════════════════════════════════");
        System.out.println("Request URL: " + req.getRequestURL());
        System.out.println("Method: " + req.getMethod());
        System.out.println("Time: " + new java.util.Date());
        
        // ─── PASS TO NEXT FILTER OR SERVLET ───
        chain.doFilter(request, response);
        
        // ─── POST-PROCESSING (After Servlet) ───
        long endTime = System.currentTimeMillis();
        System.out.println("Processing Time: " + (endTime - startTime) + " ms");
        System.out.println("═══════════════════════════════════");
    }
    
    // ═══════════════════════════════════════
    //         3. CLEANUP
    // ═══════════════════════════════════════
    @Override
    public void destroy() {
        System.out.println("LoggingFilter destroyed");
    }
}
```

### web.xml Configuration:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<web-app version="4.0" xmlns="http://xmlns.jcp.org/xml/ns/javaee">
    
    <!-- Filter Declaration -->
    <filter>
        <filter-name>LoggingFilter</filter-name>
        <filter-class>com.example.LoggingFilter</filter-class>
    </filter>
    
    <!-- Filter Mapping -->
    <filter-mapping>
        <filter-name>LoggingFilter</filter-name>
        <url-pattern>/*</url-pattern>  <!-- Apply to all URLs -->
    </filter-mapping>
    
    <!-- Servlet Declaration -->
    <servlet>
        <servlet-name>HelloServlet</servlet-name>
        <servlet-class>com.example.HelloServlet</servlet-class>
    </servlet>
    
    <servlet-mapping>
        <servlet-name>HelloServlet</servlet-name>
        <url-pattern>/hello</url-pattern>
    </servlet-mapping>
    
</web-app>
```

---

## Filter URL Patterns

| Pattern | Matches |
|---------|---------|
| `/*` | All requests |
| `/admin/*` | All URLs starting with /admin/ |
| `*.jsp` | All JSP files |
| `/login` | Only /login URL |

---

# 1. Basic Authentication Filter

---

## What is Authentication Filter?

An **Authentication Filter** checks if a user is **logged in** before allowing access to protected resources.

### Flow:

```
┌─────────────────────────────────────────────────────────────┐
│               AUTHENTICATION FILTER FLOW                    │
└─────────────────────────────────────────────────────────────┘

    User Request
         │
         ▼
    ┌─────────────────┐
    │  Auth Filter    │
    │  Is user        │
    │  logged in?     │
    └─────────────────┘
         │
    ┌────┴────┐
    │         │
   YES        NO
    │         │
    ▼         ▼
┌────────┐ ┌────────┐
│ Allow  │ │Redirect│
│ Access │ │to Login│
└────────┘ └────────┘
```

---

## AuthenticationFilter.java

```java
package com.example;

import javax.servlet.*;
import javax.servlet.http.*;
import java.io.*;

public class AuthenticationFilter implements Filter {
    
    @Override
    public void init(FilterConfig filterConfig) throws ServletException {
        System.out.println("AuthenticationFilter initialized");
    }
    
    @Override
    public void doFilter(ServletRequest request, 
                         ServletResponse response, 
                         FilterChain chain) 
            throws IOException, ServletException {
        
        HttpServletRequest httpRequest = (HttpServletRequest) request;
        HttpServletResponse httpResponse = (HttpServletResponse) response;
        
        // Get current URI
        String uri = httpRequest.getRequestURI();
        
        // ═══════════════════════════════════════
        //     SKIP FILTER FOR PUBLIC PAGES
        // ═══════════════════════════════════════
        
        // Allow access to login page, CSS, JS without authentication
        if (uri.endsWith("login.html") || 
            uri.endsWith("login") || 
            uri.endsWith(".css") || 
            uri.endsWith(".js") ||
            uri.endsWith("register")) {
            
            chain.doFilter(request, response);  // Allow access
            return;
        }
        
        // ═══════════════════════════════════════
        //     CHECK IF USER IS LOGGED IN
        // ═══════════════════════════════════════
        
        // Get session (don't create new one)
        HttpSession session = httpRequest.getSession(false);
        
        // Check if session exists and has user attribute
        if (session != null && session.getAttribute("user") != null) {
            
            // User is logged in - allow access
            System.out.println("User authenticated: " + session.getAttribute("user"));
            chain.doFilter(request, response);
            
        } else {
            
            // User NOT logged in - redirect to login
            System.out.println("Unauthorized access attempt to: " + uri);
            httpResponse.sendRedirect("login.html");
        }
    }
    
    @Override
    public void destroy() {
        System.out.println("AuthenticationFilter destroyed");
    }
}
```

---

## web.xml for Authentication Filter

```xml
<?xml version="1.0" encoding="UTF-8"?>
<web-app version="4.0" xmlns="http://xmlns.jcp.org/xml/ns/javaee">
    
    <!-- Welcome File -->
    <welcome-file-list>
        <welcome-file>login.html</welcome-file>
    </welcome-file-list>
    
    <!-- ═══════════════════════════════════════ -->
    <!--           AUTHENTICATION FILTER          -->
    <!-- ═══════════════════════════════════════ -->
    <filter>
        <filter-name>AuthFilter</filter-name>
        <filter-class>com.example.AuthenticationFilter</filter-class>
    </filter>
    
    <filter-mapping>
        <filter-name>AuthFilter</filter-name>
        <url-pattern>/*</url-pattern>  <!-- Apply to all URLs -->
    </filter-mapping>
    
    <!-- ═══════════════════════════════════════ -->
    <!--                SERVLETS                  -->
    <!-- ═══════════════════════════════════════ -->
    <servlet>
        <servlet-name>LoginServlet</servlet-name>
        <servlet-class>com.example.LoginServlet</servlet-class>
    </servlet>
    <servlet-mapping>
        <servlet-name>LoginServlet</servlet-name>
        <url-pattern>/login</url-pattern>
    </servlet-mapping>
    
    <servlet>
        <servlet-name>DashboardServlet</servlet-name>
        <servlet-class>com.example.DashboardServlet</servlet-class>
    </servlet>
    <servlet-mapping>
        <servlet-name>DashboardServlet</servlet-name>
        <url-pattern>/dashboard</url-pattern>
    </servlet-mapping>
    
    <servlet>
        <servlet-name>LogoutServlet</servlet-name>
        <servlet-class>com.example.LogoutServlet</servlet-class>
    </servlet>
    <servlet-mapping>
        <servlet-name>LogoutServlet</servlet-name>
        <url-pattern>/logout</url-pattern>
    </servlet-mapping>
    
</web-app>
```

---

## login.html

```html
<!DOCTYPE html>
<html>
<head>
    <title>Login</title>
    <style>
        body {
            font-family: Arial;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
        }
        .login-box {
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            width: 300px;
        }
        h2 { text-align: center; margin-bottom: 30px; }
        input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-sizing: border-box;
        }
        button {
            width: 100%;
            padding: 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover { background: #5a6fdc; }
    </style>
</head>
<body>
    <div class="login-box">
        <h2>Login</h2>
        <form action="login" method="POST">
            <input type="text" name="username" placeholder="Username" required>
            <input type="password" name="password" placeholder="Password" required>
            <button type="submit">Login</button>
        </form>
        <p style="text-align:center; margin-top:15px; color:#666;">
            Use: admin / admin123
        </p>
    </div>
</body>
</html>
```

---

## Multiple Filters - Filter Chain

You can have multiple filters that execute in order:

### web.xml with Multiple Filters:

```xml
<!-- Filters execute in the order they are declared -->

<!-- Filter 1: Logging -->
<filter>
    <filter-name>LoggingFilter</filter-name>
    <filter-class>com.example.LoggingFilter</filter-class>
</filter>
<filter-mapping>
    <filter-name>LoggingFilter</filter-name>
    <url-pattern>/*</url-pattern>
</filter-mapping>

<!-- Filter 2: Authentication -->
<filter>
    <filter-name>AuthFilter</filter-name>
    <filter-class>com.example.AuthenticationFilter</filter-class>
</filter>
<filter-mapping>
    <filter-name>AuthFilter</filter-name>
    <url-pattern>/*</url-pattern>
</filter-mapping>
```

### Execution Order:

```
Request → LoggingFilter → AuthFilter → Servlet
Response ← LoggingFilter ← AuthFilter ← Servlet
```

---

# Quick Reference Summary

---

## Init Parameters Quick Reference

```java
// Servlet-level (ServletConfig)
String val = getServletConfig().getInitParameter("name");

// App-level (ServletContext)
String val = getServletContext().getInitParameter("name");
```

---

## Session Management Quick Reference

### Cookies:
```java
// Create
Cookie c = new Cookie("name", "value");
c.setMaxAge(3600);
response.addCookie(c);

// Read
Cookie[] cookies = request.getCookies();
for(Cookie c : cookies) {
    c.getName(); c.getValue();
}

// Delete
Cookie c = new Cookie("name", "");
c.setMaxAge(0);
response.addCookie(c);
```

### HttpSession:
```java
// Create/Get
HttpSession session = request.getSession();

// Store
session.setAttribute("key", value);

// Retrieve
Object val = session.getAttribute("key");

// Remove
session.removeAttribute("key");

// Destroy
session.invalidate();
```

### URL Rewriting:
```java
String url = response.encodeURL("page.jsp");
```

---

## Filter Quick Reference

```java
public class MyFilter implements Filter {
    public void init(FilterConfig config) { }
    
    public void doFilter(ServletRequest req, 
                         ServletResponse resp, 
                         FilterChain chain) {
        // Pre-processing
        chain.doFilter(req, resp);  // Continue chain
        // Post-processing
    }
    
    public void destroy() { }
}
```

```xml
<filter>
    <filter-name>MyFilter</filter-name>
    <filter-class>com.example.MyFilter</filter-class>
</filter>
<filter-mapping>
    <filter-name>MyFilter</filter-name>
    <url-pattern>/*</url-pattern>
</filter-mapping>
```

---

## Exam Important Points

### Session Management:
1. HTTP is **stateless** - doesn't remember users
2. **Cookies** store data on **client**, **HttpSession** on **server**
3. `getSession(false)` returns null if no session exists
4. `invalidate()` destroys session completely
5. URL Rewriting used when **cookies are disabled**

### Filters:
1. Filters can **intercept** both request and response
2. `chain.doFilter()` passes control to next filter/servlet
3. Filters defined in web.xml execute in **declaration order**
4. Common use: **logging, authentication, compression**

### Init Parameters:
1. **ServletConfig** = single servlet scope
2. **ServletContext** = entire application scope
3. Defined in **web.xml**, accessed via `getInitParameter()`

---
